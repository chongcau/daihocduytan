<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·ªãnh d·∫°ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            background-image: radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            max-width: 1400px;
            width: 95%;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 40px);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 15px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .workspace {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            background: #f8f9fc;
        }

        .panel {
            flex: 1;
            background: white;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            position: relative;
        }

        .panel-header {
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 700;
            color: #64748b;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-radius: 16px 16px 0 0;
        }

        .count-badge {
            background: #e2e8f0;
            color: #475569;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
            transition: 0.3s;
        }

        .count-badge.active {
            background: #dbeafe;
            color: #2563eb;
        }

        /* Badge m√†u cam c·∫£nh b√°o tr√πng */
        .count-badge.warning {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fdba74;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        textarea {
            flex: 1;
            border: none;
            padding: 20px;
            resize: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #334155;
            background: transparent;
            outline: none;
        }

        .btn-icon {
            background: white;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .btn-icon:hover {
            background: #f8fafc;
            border-color: #cbd5e0;
            color: #0f172a;
        }

        /* --- MODAL (POPUP) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: translateY(20px);
            transition: 0.3s;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal h3 {
            margin: 0 0 10px 0;
            color: #1e293b;
        }

        .modal p {
            color: #64748b;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-primary {
            background: #ea580c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                overflow-y: auto;
            }

            .app-container {
                height: auto;
                min-height: calc(100vh - 40px);
                margin: 20px 10px;
                width: auto;
                overflow: visible;
            }

            .workspace {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
                overflow: visible;
            }

            .panel {
                min-height: 350px;
                flex: none;
            }

            textarea {
                font-size: 16px !important;
            }

            .btn-icon {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* N√∫t nh·ªè h∆°n x√≠u tr√™n mobile */
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="header">
            <h1>‚ú® ƒê·ªãnh d·∫°ng v√† ph√°t hi·ªán c√¢u tr√πng</h1>
        </div>

        <div class="workspace">
            <div class="panel">
                <div class="panel-header">
                    <div style="display:flex; align-items:center;">
                        INPUT
                        <span id="inputCount" class="count-badge">0 c√¢u</span>
                    </div>
                    <div class="controls">
                        <button class="btn-icon" onclick="pasteInput()"
                            style="color: #2563eb; border-color: #bfdbfe;">üìã D√°n</button>
                        <button class="btn-icon" onclick="checkDuplicateManual()"
                            style="color: #ea580c; border-color: #fdba74;">üîç T√¨m tr√πng</button>
                        <button class="btn-icon" onclick="clearInput()"
                            style="color: #ef4444; border-color: #fecaca;">X√≥a</button>
                    </div>
                </div>
                <textarea id="inputText" placeholder="Paste c√¢u h·ªèi v√†o ƒë√¢y..."></textarea>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div style="display:flex; align-items:center;">
                        OUTPUT
                        <span id="outputCount" class="count-badge">0 c√¢u</span>
                    </div>
                    <button class="btn-icon" onclick="copyResult()">üìã Sao ch√©p</button>
                </div>
                <textarea id="outputText" readonly placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ra ·ªü ƒë√¢y..."></textarea>
            </div>
        </div>
    </div>

    <div id="duplicateModal" class="modal-overlay">
        <div class="modal">
            <h3>‚ö†Ô∏è Ph√°t hi·ªán tr√πng l·∫∑p!</h3>
            <p id="duplicateMsg">...</p>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="confirmDuplicate(false)">Gi·ªØ l·∫°i h·∫øt</button>
                <button class="btn-primary" onclick="confirmDuplicate(true)">X√≥a c√¢u tr√πng</button>
            </div>
        </div>
    </div>

    <script>
        const inputArea = document.getElementById('inputText');
        const outputArea = document.getElementById('outputText');
        const inputCountBadge = document.getElementById('inputCount');
        const outputCountBadge = document.getElementById('outputCount');
        const modal = document.getElementById('duplicateModal');
        const duplicateMsg = document.getElementById('duplicateMsg');

        let parsedQuestions = [];

        // 1. Khi g√µ ph√≠m -> Ch·ªâ format nh·∫π nh√†ng, kh√¥ng hi·ªán popup
        inputArea.addEventListener('input', function () {
            processData(false);
        });

        // 2. Khi D√°n th·ªß c√¥ng (Ctrl+V ho·∫∑c menu chu·ªôt ph·∫£i) -> T·ª∞ ƒê·ªòNG CHECK TR√ôNG
        inputArea.addEventListener('paste', function () {
            // C·∫ßn setTimeout nh·ªè ƒë·ªÉ ch·ªù d·ªØ li·ªáu th·ª±c s·ª± d√°n v√†o √¥ input
            setTimeout(() => {
                processData(true);
            }, 100);
        });

        function checkDuplicateManual() {
            if (!inputArea.value.trim()) {
                alert("B·∫°n ch∆∞a nh·∫≠p n·ªôi dung n√†o!");
                return;
            }
            processData(true); // B·∫Øt bu·ªôc check tr√πng

            // N·∫øu kh√¥ng c√≥ tr√πng, b√°o cho ng∆∞·ªùi d√πng bi·∫øt
            let duplicates = countDuplicates(parsedQuestions);
            if (duplicates === 0) {
                alert("‚úÖ Tuy·ªát v·ªùi! Kh√¥ng t√¨m th·∫•y c√¢u n√†o b·ªã tr√πng.");
            }
        }

        // --- H√ÄM X·ª¨ L√ù TRUNG T√ÇM ---
        function processData(checkDup = false) {
            let text = inputArea.value;
            // T√°ch c√°c kh·ªëi b·∫Øt ƒë·∫ßu b·∫±ng Question + s·ªë
            let rawBlocks = text.split(/(?=Question\s+\d+)/i);

            parsedQuestions = [];

            rawBlocks.forEach(block => {
                block = block.trim();
                if (!block) return;

                let matchHeader = block.match(/Question\s+(\d+)(.*)/is);
                if (matchHeader) {
                    let qNum = matchHeader[1];
                    let restOfContent = block.replace(/Question\s+\d+.*(\r?\n)?/, '');

                    let lines = restOfContent.split(/\r?\n/);
                    let qContent = [];
                    let qAnswers = [];

                    lines.forEach(line => {
                        line = line.trim();
                        if (line === "" || line.includes("Points") || line === "Reset Selection") return;

                        if (line.match(/^[A-D]\./)) {
                            qAnswers.push(line);
                        } else {
                            qContent.push(line);
                        }
                    });

                    parsedQuestions.push({
                        originalNum: qNum,
                        content: qContent.join(" "),
                        fullContentLines: qContent,
                        answers: qAnswers,
                        isDuplicate: false
                    });
                }
            });

            // Update Input Badge
            inputCountBadge.innerText = `${parsedQuestions.length} c√¢u g·ªëc`;
            if (parsedQuestions.length > 0) inputCountBadge.classList.add('active');
            else inputCountBadge.classList.remove('active');

            // --- KI·ªÇM TRA TR√ôNG L·∫∂P ---
            if (checkDup && parsedQuestions.length > 0) {
                let dupCount = countDuplicates(parsedQuestions);
                if (dupCount > 0) {
                    duplicateMsg.innerText = `T√¨m th·∫•y ${dupCount} c√¢u h·ªèi b·ªã tr√πng l·∫∑p ho√†n to√†n (c√πng n·ªôi dung v√† ƒë√°p √°n). B·∫°n c√≥ mu·ªën x√≥a b·ªõt kh√¥ng?`;
                    modal.classList.add('show');
                    return; // D·ª´ng l·∫°i ch·ªù ng∆∞·ªùi d√πng ch·ªçn
                }
            }

            // M·∫∑c ƒë·ªãnh xu·∫•t k·∫øt qu·∫£ (Gi·ªØ nguy√™n)
            renderOutput(parsedQuestions);
        }

        // H√†m ƒë·∫øm v√† ƒë√°nh d·∫•u tr√πng
        function countDuplicates(questions) {
            let uniqueSet = new Set();
            let dupCount = 0;

            questions.forEach(q => {
                // T·∫°o ch·ªØ k√Ω: N·ªôi dung + C√°c ƒë√°p √°n (vi·∫øt li·ªÅn, ch·ªØ th∆∞·ªùng)
                let signature = (q.content + q.answers.join("")).toLowerCase().replace(/\s/g, '');

                // N·∫øu signature r·ªóng (c√¢u h·ªèi l·ªói kh√¥ng n·ªôi dung) th√¨ b·ªè qua check tr√πng
                if (signature.length < 5) return;

                if (uniqueSet.has(signature)) {
                    dupCount++;
                    q.isDuplicate = true; // ƒê√°nh d·∫•u
                } else {
                    uniqueSet.add(signature);
                    q.isDuplicate = false;
                }
            });
            return dupCount;
        }

        function confirmDuplicate(shouldDelete) {
            modal.classList.remove('show');

            let finalQuestions = parsedQuestions;
            if (shouldDelete) {
                finalQuestions = parsedQuestions.filter(q => !q.isDuplicate);
            }
            renderOutput(finalQuestions);
        }

        function renderOutput(questions) {
            let resultText = [];

            questions.forEach((q, index) => {
                let newNum = index + 1;
                let contentStr = "";
                if (q.fullContentLines.length > 0) {
                    contentStr = q.fullContentLines[0];
                    for (let i = 1; i < q.fullContentLines.length; i++) {
                        contentStr += "\n" + q.fullContentLines[i];
                    }
                } else {
                    contentStr = "(Kh√¥ng c√≥ n·ªôi dung)";
                }

                resultText.push(`C√¢u ${newNum}: ${contentStr}`);
                q.answers.forEach(ans => resultText.push(ans));
                if (index < questions.length - 1) resultText.push("");
            });

            outputArea.value = resultText.join("\n");

            // C·∫≠p nh·∫≠t Output Badge
            outputCountBadge.innerText = `${questions.length} c√¢u`;
            outputCountBadge.classList.add('active');

            // N·∫øu s·ªë l∆∞·ª£ng Output √≠t h∆°n Input -> ƒê·ªïi m√†u cam c·∫£nh b√°o (c√≥ l·ªçc tr√πng)
            if (questions.length < parsedQuestions.length) {
                outputCountBadge.innerText = `${questions.length} c√¢u (ƒê√£ l·ªçc)`;
                outputCountBadge.classList.add('warning');
            } else {
                outputCountBadge.classList.remove('warning');
            }
        }

        async function pasteInput() {
            try {
                const text = await navigator.clipboard.readText();
                inputArea.value = text;
                processData(true); // C√≥ check tr√πng
                if (window.innerWidth > 768) inputArea.focus();
            } catch (err) {
                alert('Vui l√≤ng d√°n th·ªß c√¥ng (Ctrl+V) v√†o √¥ input.');
            }
        }

        function clearInput() {
            inputArea.value = "";
            outputArea.value = "";
            inputCountBadge.innerText = "0 c√¢u";
            inputCountBadge.classList.remove('active');
            outputCountBadge.innerText = "0 c√¢u";
            outputCountBadge.classList.remove('active', 'warning');
            parsedQuestions = [];
            inputArea.focus();
        }

        function copyResult() {
            if (!outputArea.value) return;
            outputArea.select();
            outputArea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(outputArea.value);

            const btn = document.querySelector('.panel:last-child .btn-icon');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ ƒê√£ Copy";
            setTimeout(() => btn.innerHTML = originalText, 1500);
        }
    </script>

</body>

</html>