<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·ªãnh d·∫°ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            background-image: radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            max-width: 1400px;
            width: 95%;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 40px);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 15px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .workspace {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            background: #f8f9fc;
        }

        .panel {
            flex: 1;
            background: white;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            position: relative;
        }

        .panel-header {
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 700;
            color: #64748b;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-radius: 16px 16px 0 0;
        }

        .count-badge {
            background: #e2e8f0;
            color: #475569;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
            transition: 0.3s;
        }

        .count-badge.active {
            background: #dbeafe;
            color: #2563eb;
        }

        /* BADGE C·∫¢NH B√ÅO TR√ôNG (M·ªõi) */
        .dup-warning {
            display: none;
            /* M·∫∑c ƒë·ªãnh ·∫©n */
            align-items: center;
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fdba74;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        textarea {
            flex: 1;
            border: none;
            padding: 20px;
            resize: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #334155;
            background: transparent;
            outline: none;
        }

        .btn-icon {
            background: white;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .btn-icon:hover {
            background: #f8fafc;
            border-color: #cbd5e0;
            color: #0f172a;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: translateY(20px);
            transition: 0.3s;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal h3 {
            margin: 0 0 10px 0;
            color: #1e293b;
        }

        .modal p {
            color: #64748b;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-primary {
            background: #ea580c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                overflow-y: auto;
            }

            .app-container {
                height: auto;
                min-height: calc(100vh - 40px);
                margin: 20px 10px;
                width: auto;
                overflow: visible;
            }

            .workspace {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
                overflow: visible;
            }

            .panel {
                min-height: 350px;
                flex: none;
            }

            textarea {
                font-size: 16px !important;
            }

            .btn-icon {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="header">
            <h1>‚ú® ƒê·ªãnh d·∫°ng & X·ª≠ l√Ω c√¢u h·ªèi</h1>
        </div>

        <div class="workspace">
            <div class="panel">
                <div class="panel-header">
                    <div style="display:flex; align-items:center;">
                        INPUT
                        <span id="inputCount" class="count-badge">0 c√¢u</span>
                    </div>
                    <div class="controls">
                        <span id="dupWarning" class="dup-warning">‚ö†Ô∏è Tr√πng: 0</span>

                        <button class="btn-icon" onclick="pasteInput()"
                            style="color: #2563eb; border-color: #bfdbfe;">üìã D√°n</button>
                        <button class="btn-icon" onclick="checkDuplicateManual()"
                            style="color: #ea580c; border-color: #fdba74;">üîç Check</button>
                        <button class="btn-icon" onclick="clearInput()"
                            style="color: #ef4444; border-color: #fecaca;">X√≥a</button>
                    </div>
                </div>
                <textarea id="inputText" placeholder="Paste c√¢u h·ªèi v√†o ƒë√¢y..."></textarea>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div style="display:flex; align-items:center;">
                        OUTPUT
                        <span id="outputCount" class="count-badge">0 c√¢u</span>
                    </div>
                    <button class="btn-icon" onclick="copyResult()">üìã Sao ch√©p</button>
                </div>
                <textarea id="outputText" readonly placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ra ·ªü ƒë√¢y..."></textarea>
            </div>
        </div>
    </div>

    <div id="duplicateModal" class="modal-overlay">
        <div class="modal">
            <h3>‚ö†Ô∏è Ph√°t hi·ªán tr√πng l·∫∑p!</h3>
            <p id="duplicateMsg">...</p>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="confirmDuplicate(false)">Gi·ªØ l·∫°i (Hi·ªÉn th·ªã tr√πng)</button>
                <button class="btn-primary" onclick="confirmDuplicate(true)">X√≥a c√¢u tr√πng</button>
            </div>
        </div>
    </div>

    <script>
        const inputArea = document.getElementById('inputText');
        const outputArea = document.getElementById('outputText');
        const inputCountBadge = document.getElementById('inputCount');
        const outputCountBadge = document.getElementById('outputCount');
        const modal = document.getElementById('duplicateModal');
        const duplicateMsg = document.getElementById('duplicateMsg');
        const dupWarning = document.getElementById('dupWarning');

        let parsedQuestions = [];

        // Khi g√µ tay th√¨ ·∫©n c·∫£nh b√°o tr√πng ƒëi v√¨ n·ªôi dung thay ƒë·ªïi
        inputArea.addEventListener('input', function () {
            dupWarning.style.display = 'none';
            processData(false);
        });

        // S·ª± ki·ªán Paste -> Check tr√πng ngay l·∫≠p t·ª©c
        inputArea.addEventListener('paste', function () {
            setTimeout(() => { processData(true); }, 100);
        });

        function checkDuplicateManual() {
            if (!inputArea.value.trim()) {
                alert("B·∫°n ch∆∞a nh·∫≠p n·ªôi dung n√†o!");
                return;
            }
            processData(true);
            let duplicates = countDuplicates(parsedQuestions);
            if (duplicates === 0) {
                alert("‚úÖ Tuy·ªát v·ªùi! Kh√¥ng t√¨m th·∫•y c√¢u n√†o b·ªã tr√πng.");
                dupWarning.style.display = 'none';
            }
        }

        function processData(checkDup = false) {
            let text = inputArea.value;
            let rawBlocks = text.split(/(?=Question\s+\d+)/i);

            parsedQuestions = [];

            rawBlocks.forEach(block => {
                block = block.trim();
                if (!block) return;

                let matchHeader = block.match(/Question\s+(\d+)(.*)/is);
                if (matchHeader) {
                    let qNum = matchHeader[1];
                    let restOfContent = block.replace(/Question\s+\d+.*(\r?\n)?/, '');
                    let lines = restOfContent.split(/\r?\n/);
                    let qContent = [];
                    let qAnswers = [];

                    lines.forEach(line => {
                        line = line.trim();
                        // Filter r√°c
                        if (line === "" || line.includes("Points") || line === "Reset Selection" ||
                            line.includes("Maximum number of characters") || line.includes("Show Rich-Text Editor")) {
                            return;
                        }
                        if (line.match(/^[A-D]\./)) qAnswers.push(line);
                        else qContent.push(line);
                    });

                    parsedQuestions.push({
                        originalNum: qNum,
                        content: qContent.join(" "),
                        fullContentLines: qContent,
                        answers: qAnswers,
                        raw: block, // L∆∞u text g·ªëc ƒë·ªÉ t√°i t·∫°o input n·∫øu c·∫ßn
                        isDuplicate: false
                    });
                }
            });

            inputCountBadge.innerText = `${parsedQuestions.length} c√¢u g·ªëc`;
            if (parsedQuestions.length > 0) inputCountBadge.classList.add('active');
            else inputCountBadge.classList.remove('active');

            // --- LOGIC X·ª¨ L√ù TR√ôNG L·∫∂P ---
            if (checkDup && parsedQuestions.length > 0) {
                let dupCount = countDuplicates(parsedQuestions);
                if (dupCount > 0) {
                    // N·∫øu c√≥ tr√πng -> Hi·ªán Modal h·ªèi
                    duplicateMsg.innerText = `T√¨m th·∫•y ${dupCount} c√¢u h·ªèi b·ªã tr√πng l·∫∑p.`;
                    modal.classList.add('show');
                    return; // D·ª´ng l·∫°i, ch∆∞a render v·ªôi, ch·ªù ng∆∞·ªùi d√πng ch·ªçn
                } else {
                    // Kh√¥ng tr√πng -> ·∫®n badge
                    dupWarning.style.display = 'none';
                }
            }

            // N·∫øu kh√¥ng check tr√πng (g√µ tay) ho·∫∑c kh√¥ng c√≥ tr√πng -> Render b√¨nh th∆∞·ªùng
            renderOutput(parsedQuestions);
        }

        function countDuplicates(questions) {
            let uniqueSet = new Set();
            let dupCount = 0;
            questions.forEach(q => {
                let signature = (q.content + q.answers.join("")).toLowerCase().replace(/\s/g, '');
                if (signature.length < 5) return;
                if (uniqueSet.has(signature)) {
                    dupCount++;
                    q.isDuplicate = true;
                } else {
                    uniqueSet.add(signature);
                    q.isDuplicate = false;
                }
            });
            return dupCount;
        }

        // --- H√ÄM X·ª¨ L√ù L·ª∞A CH·ªåN C·ª¶A NG∆Ø·ªúI D√ôNG ---
        function confirmDuplicate(shouldDelete) {
            modal.classList.remove('show');

            // T√≠nh l·∫°i s·ªë l∆∞·ª£ng tr√πng hi·ªán t·∫°i ƒë·ªÉ hi·ªÉn th·ªã
            let totalDups = parsedQuestions.filter(q => q.isDuplicate).length;

            if (shouldDelete) {
                // 1. NG∆Ø·ªúI D√ôNG CH·ªåN X√ìA
                let finalQuestions = parsedQuestions.filter(q => !q.isDuplicate);

                // C·∫≠p nh·∫≠t l·∫°i INPUT (X√≥a s·∫°ch g·ªëc)
                let newInputText = finalQuestions.map(q => q.raw).join("\n\n");
                inputArea.value = newInputText;

                // C·∫≠p nh·∫≠t bi·∫øn global
                parsedQuestions = finalQuestions;

                // ·∫®n badge c·∫£nh b√°o (v√¨ ƒë√£ x√≥a h·∫øt r·ªìi)
                dupWarning.style.display = 'none';

                // Render l·∫°i Output
                renderOutput(parsedQuestions);

                // Reset ƒë·∫øm input badge
                inputCountBadge.innerText = `${parsedQuestions.length} c√¢u g·ªëc`;

            } else {
                // 2. NG∆Ø·ªúI D√ôNG CH·ªåN GI·ªÆ L·∫†I
                // Hi·ªán badge c·∫£nh b√°o m√†u cam
                dupWarning.innerText = `‚ö†Ô∏è Tr√πng: ${totalDups}`;
                dupWarning.style.display = 'inline-flex';

                // Render Output (v·∫´n gi·ªØ nguy√™n c√¢u tr√πng)
                renderOutput(parsedQuestions);
            }
        }

        function renderOutput(questions) {
            let resultText = [];
            questions.forEach((q, index) => {
                let newNum = index + 1;
                let contentStr = q.fullContentLines.length > 0 ? q.fullContentLines.join("\n") : "(Kh√¥ng c√≥ n·ªôi dung)";

                resultText.push(`C√¢u ${newNum}: ${contentStr}`);

                if (q.answers.length > 0) q.answers.forEach(ans => resultText.push(ans));
                else resultText.push("Tr·∫£ l·ªùi");

                if (index < questions.length - 1) resultText.push("");
            });

            outputArea.value = resultText.join("\n");
            outputCountBadge.innerText = `${questions.length} c√¢u`;
            outputCountBadge.classList.add('active');
        }

        async function pasteInput() {
            try {
                const text = await navigator.clipboard.readText();
                inputArea.value = text;
                processData(true);
                if (window.innerWidth > 768) inputArea.focus();
            } catch (err) {
                alert('Vui l√≤ng d√°n th·ªß c√¥ng (Ctrl+V).');
            }
        }

        function clearInput() {
            inputArea.value = "";
            outputArea.value = "";
            inputCountBadge.innerText = "0 c√¢u"; inputCountBadge.classList.remove('active');
            outputCountBadge.innerText = "0 c√¢u"; outputCountBadge.classList.remove('active');
            dupWarning.style.display = 'none';
            parsedQuestions = [];
            inputArea.focus();
        }

        function copyResult() {
            if (!outputArea.value) return;
            outputArea.select();
            outputArea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(outputArea.value);
            const btn = document.querySelector('.panel:last-child .btn-icon');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ ƒê√£ Copy";
            setTimeout(() => btn.innerHTML = originalText, 1500);
        }
    </script>

</body>

</html>